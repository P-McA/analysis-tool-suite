<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIXML Field Analysis Tool</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .drop-zone {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .drop-zone:hover {
            border-color: #007bff;
            background-color: #f8f9fa;
        }
        .drop-zone.dragover {
            border-color: #007bff;
            background-color: #e3f2fd;
        }
        .drop-zone__input {
            display: none;
        }
        .venue-card {
            margin-bottom: 20px;
        }
        .matrix-table {
            font-size: 0.8rem;
        }
        .matrix-table th {
            position: sticky;
            top: 0;
            background-color: #f8f9fa;
            z-index: 10;
        }
        .matrix-table .field-name {
            position: sticky;
            left: 0;
            background-color: white;
            z-index: 5;
            border-right: 2px solid #dee2e6;
        }
        .matrix-table .field-name:first-child {
            z-index: 15;
        }
        .present {
            background-color: #d4edda !important;
        }
        .absent {
            background-color: #f8d7da !important;
        }
        .table-container {
            max-height: 600px;
            overflow: auto;
            border: 1px solid #dee2e6;
        }
        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .stats-card {
            transition: transform 0.2s;
        }
        .stats-card:hover {
            transform: translateY(-2px);
        }
        .pattern-badge {
            margin: 2px;
        }
        .field-filter {
            position: sticky;
            top: 0;
            background: white;
            z-index: 20;
            padding: 10px 0;
            border-bottom: 1px solid #dee2e6;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">
                    <i class="fas fa-chart-network me-2"></i>
                    FIXML Field Analysis Tool
                </h1>
                <p class="lead">Analyze FIXML field presence, enumeration values, and presence patterns across multiple trading venues.</p>
            </div>
        </div>

        <!-- File Upload Section -->
        <div id="uploadSection">
            <form id="venueUploadForm" enctype="multipart/form-data">
                <div class="row mb-4">
                    <div class="col-12">
                        <h3><i class="fas fa-upload me-2"></i>Upload Venue CSV Files</h3>
                        <p class="text-muted">Upload CSV files containing FIXML field specifications for each trading venue. Each file should contain columns: field_name, enumValues, and Presence.</p>
                    </div>
                </div>

                <div class="row">
                    <!-- Venue 1 -->
                    <div class="col-lg-6 col-xl-3 mb-4">
                        <div class="card venue-card">
                            <div class="card-header">
                                <h5 class="mb-0">Venue 1</h5>
                            </div>
                            <div class="card-body">
                                <input type="text" class="form-control mb-3" name="venueName1" placeholder="Enter venue name" value="Venue 1">
                                <div class="drop-zone" data-venue="1">
                                    <i class="fas fa-cloud-upload-alt fa-2x mb-2 text-muted"></i>
                                    <span class="drop-zone__prompt">Drop CSV file or click to upload</span>
                                    <input type="file" name="venue1" class="drop-zone__input" accept=".csv">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Venue 2 -->
                    <div class="col-lg-6 col-xl-3 mb-4">
                        <div class="card venue-card">
                            <div class="card-header">
                                <h5 class="mb-0">Venue 2</h5>
                            </div>
                            <div class="card-body">
                                <input type="text" class="form-control mb-3" name="venueName2" placeholder="Enter venue name" value="Venue 2">
                                <div class="drop-zone" data-venue="2">
                                    <i class="fas fa-cloud-upload-alt fa-2x mb-2 text-muted"></i>
                                    <span class="drop-zone__prompt">Drop CSV file or click to upload</span>
                                    <input type="file" name="venue2" class="drop-zone__input" accept=".csv">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Venue 3 -->
                    <div class="col-lg-6 col-xl-3 mb-4">
                        <div class="card venue-card">
                            <div class="card-header">
                                <h5 class="mb-0">Venue 3</h5>
                            </div>
                            <div class="card-body">
                                <input type="text" class="form-control mb-3" name="venueName3" placeholder="Enter venue name" value="Venue 3">
                                <div class="drop-zone" data-venue="3">
                                    <i class="fas fa-cloud-upload-alt fa-2x mb-2 text-muted"></i>
                                    <span class="drop-zone__prompt">Drop CSV file or click to upload</span>
                                    <input type="file" name="venue3" class="drop-zone__input" accept=".csv">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Venue 4 -->
                    <div class="col-lg-6 col-xl-3 mb-4">
                        <div class="card venue-card">
                            <div class="card-header">
                                <h5 class="mb-0">Venue 4</h5>
                            </div>
                            <div class="card-body">
                                <input type="text" class="form-control mb-3" name="venueName4" placeholder="Enter venue name" value="Venue 4">
                                <div class="drop-zone" data-venue="4">
                                    <i class="fas fa-cloud-upload-alt fa-2x mb-2 text-muted"></i>
                                    <span class="drop-zone__prompt">Drop CSV file or click to upload</span>
                                    <input type="file" name="venue4" class="drop-zone__input" accept=".csv">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-12 text-center">
                        <button type="submit" class="btn btn-primary btn-lg" id="analyzeBtn" disabled>
                            <i class="fas fa-chart-line me-2"></i>Analyze FIXML Fields
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" style="display: none;">
            <!-- Summary Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card stats-card h-100 summary-card">
                        <div class="card-body text-center">
                            <i class="fas fa-list-alt fa-2x mb-2"></i>
                            <h5 class="card-title">Total Fields</h5>
                            <h2 id="totalFields">-</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card h-100 bg-success text-white">
                        <div class="card-body text-center">
                            <i class="fas fa-check-circle fa-2x mb-2"></i>
                            <h5 class="card-title">All Venues</h5>
                            <h2 id="fieldsInAllVenues">-</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card h-100 bg-warning text-white">
                        <div class="card-body text-center">
                            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                            <h5 class="card-title">Multiple Venues</h5>
                            <h2 id="fieldsInMultipleVenues">-</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card h-100 bg-danger text-white">
                        <div class="card-body text-center">
                            <i class="fas fa-times-circle fa-2x mb-2"></i>
                            <h5 class="card-title">Single Venue</h5>
                            <h2 id="fieldsInOneVenue">-</h2>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analysis Tabs -->
            <ul class="nav nav-tabs mb-4" id="analysisTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="field-presence-tab" data-bs-toggle="tab"
                            data-bs-target="#field-presence" type="button" role="tab">
                        <i class="fas fa-table me-2"></i>Field Presence Matrix
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="enum-values-tab" data-bs-toggle="tab"
                            data-bs-target="#enum-values" type="button" role="tab">
                        <i class="fas fa-list me-2"></i>Enumeration Values
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="presence-patterns-tab" data-bs-toggle="tab"
                            data-bs-target="#presence-patterns" type="button" role="tab">
                        <i class="fas fa-pattern me-2"></i>Presence Patterns
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="summary-stats-tab" data-bs-toggle="tab"
                            data-bs-target="#summary-stats" type="button" role="tab">
                        <i class="fas fa-chart-bar me-2"></i>Summary Statistics
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="analysisTabsContent">
                <!-- Field Presence Matrix -->
                <div class="tab-pane fade show active" id="field-presence" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-table me-2"></i>Field Presence Across Venues
                            </h5>
                            <small class="text-muted">Green indicates field is present, red indicates absent</small>
                        </div>
                        <div class="card-body">
                            <div class="field-filter">
                                <div class="row">
                                    <div class="col-md-6">
                                        <input type="text" class="form-control" id="fieldFilter"
                                               placeholder="Filter fields by name...">
                                    </div>
                                    <div class="col-md-6">
                                        <select class="form-select" id="presenceFilter">
                                            <option value="">All fields</option>
                                            <option value="all">Present in all venues</option>
                                            <option value="multiple">Present in multiple venues</option>
                                            <option value="single">Present in single venue only</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="table-container">
                                <table class="table table-bordered table-sm matrix-table" id="fieldPresenceTable">
                                    <thead>
                                        <tr>
                                            <th class="field-name">Field Name</th>
                                            <!-- Venue columns will be added dynamically -->
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Field rows will be added dynamically -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enumeration Values -->
                <div class="tab-pane fade" id="enum-values" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-list me-2"></i>Enumeration Values by Venue
                            </h5>
                            <small class="text-muted">Shows which fields use specific enumeration values in each venue</small>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table class="table table-bordered table-sm" id="enumValuesTable">
                                    <thead>
                                        <tr>
                                            <th>Enumeration Value</th>
                                            <!-- Venue columns will be added dynamically -->
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Enum rows will be added dynamically -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Presence Patterns -->
                <div class="tab-pane fade" id="presence-patterns" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-pattern me-2"></i>Presence Patterns
                            </h5>
                            <small class="text-muted">Fields grouped by their presence patterns across venues</small>
                        </div>
                        <div class="card-body">
                            <div id="presencePatternsContent">
                                <!-- Pattern groups will be added dynamically -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Summary Statistics -->
                <div class="tab-pane fade" id="summary-stats" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-chart-bar me-2"></i>Summary Statistics
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <canvas id="fieldDistributionChart" width="400" height="200"></canvas>
                                </div>
                                <div class="col-md-6">
                                    <canvas id="presenceDistributionChart" width="400" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-12 text-center">
                    <button class="btn btn-secondary" id="newAnalysisBtn">
                        <i class="fas fa-plus me-2"></i>Run New Analysis
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // Global variables
        let analysisData = null;
        let uploadedFiles = {};

        // Initialize drop zones
        document.addEventListener('DOMContentLoaded', function() {
            initializeDropZones();
            setupEventListeners();
        });

        function initializeDropZones() {
            document.querySelectorAll('.drop-zone').forEach(dropZone => {
                const input = dropZone.querySelector('.drop-zone__input');
                const prompt = dropZone.querySelector('.drop-zone__prompt');

                dropZone.addEventListener('click', () => input.click());

                input.addEventListener('change', (e) => {
                    if (e.target.files.length) {
                        handleFileUpload(dropZone, e.target.files[0]);
                    }
                });

                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.classList.add('dragover');
                });

                dropZone.addEventListener('dragleave', () => {
                    dropZone.classList.remove('dragover');
                });

                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('dragover');

                    if (e.dataTransfer.files.length) {
                        input.files = e.dataTransfer.files;
                        handleFileUpload(dropZone, e.dataTransfer.files[0]);
                    }
                });
            });
        }

        function handleFileUpload(dropZone, file) {
            const venue = dropZone.dataset.venue;
            const prompt = dropZone.querySelector('.drop-zone__prompt');

            if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) {
                alert('Please upload only CSV files');
                return;
            }

            prompt.innerHTML = `<i class="fas fa-check-circle text-success me-2"></i>${file.name}`;
            uploadedFiles[venue] = file;

            checkAllFilesUploaded();
        }

        function checkAllFilesUploaded() {
            const analyzeBtn = document.getElementById('analyzeBtn');
            if (Object.keys(uploadedFiles).length === 4) {
                analyzeBtn.disabled = false;
            }
        }

        function setupEventListeners() {
            // Form submission
            document.getElementById('venueUploadForm').addEventListener('submit', function(e) {
                e.preventDefault();
                performAnalysis();
            });

            // New analysis button
            document.getElementById('newAnalysisBtn').addEventListener('click', function() {
                document.getElementById('resultsSection').style.display = 'none';
                document.getElementById('uploadSection').style.display = 'block';

                // Reset form
                document.getElementById('venueUploadForm').reset();
                uploadedFiles = {};
                document.getElementById('analyzeBtn').disabled = true;

                // Reset drop zones
                document.querySelectorAll('.drop-zone__prompt').forEach(prompt => {
                    prompt.innerHTML = '<i class="fas fa-cloud-upload-alt fa-2x mb-2 text-muted"></i><span>Drop CSV file or click to upload</span>';
                });
            });

            // Field filtering
            document.getElementById('fieldFilter').addEventListener('input', filterFieldTable);
            document.getElementById('presenceFilter').addEventListener('change', filterFieldTable);
        }

        function performAnalysis() {
            const formData = new FormData(document.getElementById('venueUploadForm'));

            // Show loading state
            const analyzeBtn = document.getElementById('analyzeBtn');
            const originalText = analyzeBtn.innerHTML;
            analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Analyzing...';
            analyzeBtn.disabled = true;

            fetch('/upload_fixml_venues', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    analysisData = data;
                    displayResults(data);
                } else {
                    alert('Error: ' + (data.error || 'Analysis failed'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred during analysis');
            })
            .finally(() => {
                analyzeBtn.innerHTML = originalText;
                analyzeBtn.disabled = false;
            });
        }

        function displayResults(data) {
            // Update summary cards
            document.getElementById('totalFields').textContent = data.total_fields;
            document.getElementById('fieldsInAllVenues').textContent = data.summary.fields_in_all_venues;
            document.getElementById('fieldsInMultipleVenues').textContent = data.summary.fields_in_multiple_venues;
            document.getElementById('fieldsInOneVenue').textContent = data.summary.fields_in_one_venue;

            // Generate matrices
            generateFieldPresenceMatrix(data);
            generateEnumValuesTable(data);
            generatePresencePatternsView(data);
            generateCharts(data);

            // Show results section
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'block';
        }

        function generateFieldPresenceMatrix(data) {
            const table = document.getElementById('fieldPresenceTable');
            const thead = table.querySelector('thead tr');
            const tbody = table.querySelector('tbody');

            // Clear existing content
            thead.innerHTML = '<th class="field-name">Field Name</th>';
            tbody.innerHTML = '';

            // Add venue columns
            data.venue_names.forEach(venueName => {
                const th = document.createElement('th');
                th.textContent = venueName;
                th.style.minWidth = '100px';
                thead.appendChild(th);
            });

            // Add field rows
            Object.keys(data.field_matrix).forEach(fieldName => {
                const row = document.createElement('tr');
                row.dataset.fieldName = fieldName.toLowerCase();

                // Field name cell
                const fieldCell = document.createElement('td');
                fieldCell.className = 'field-name';
                fieldCell.textContent = fieldName;
                fieldCell.style.minWidth = '300px';
                row.appendChild(fieldCell);

                // Venue presence cells
                data.venues.forEach(venue => {
                    const cell = document.createElement('td');
                    const isPresent = data.field_matrix[fieldName][venue];
                    cell.className = isPresent ? 'present text-center' : 'absent text-center';
                    cell.innerHTML = isPresent ? '<i class="fas fa-check"></i>' : '<i class="fas fa-times"></i>';
                    row.appendChild(cell);
                });

                tbody.appendChild(row);
            });
        }

        function generateEnumValuesTable(data) {
            const table = document.getElementById('enumValuesTable');
            const thead = table.querySelector('thead tr');
            const tbody = table.querySelector('tbody');

            // Clear existing content
            thead.innerHTML = '<th>Enumeration Value</th>';
            tbody.innerHTML = '';

            // Add venue columns
            data.venue_names.forEach(venueName => {
                const th = document.createElement('th');
                th.textContent = venueName;
                thead.appendChild(th);
            });

            // Add enum value rows
            Object.keys(data.enum_matrix).forEach(enumValue => {
                const row = document.createElement('tr');

                // Enum value cell
                const enumCell = document.createElement('td');
                enumCell.innerHTML = `<strong>${enumValue}</strong>`;
                row.appendChild(enumCell);

                // Venue cells
                data.venues.forEach(venue => {
                    const cell = document.createElement('td');
                    const fields = data.enum_matrix[enumValue][venue];

                    if (fields.length > 0) {
                        cell.innerHTML = `<small>${fields.length} field(s)</small><br>` +
                            fields.slice(0, 3).map(f => `<span class="badge bg-secondary me-1">${f}</span>`).join('') +
                            (fields.length > 3 ? `<span class="text-muted">+${fields.length - 3} more</span>` : '');
                    } else {
                        cell.innerHTML = '<span class="text-muted">-</span>';
                    }

                    row.appendChild(cell);
                });

                tbody.appendChild(row);
            });
        }

        function generatePresencePatternsView(data) {
            const container = document.getElementById('presencePatternsContent');
            container.innerHTML = '';

            Object.keys(data.presence_patterns).forEach(pattern => {
                const fields = data.presence_patterns[pattern];
                const patternArray = JSON.parse(pattern);

                const card = document.createElement('div');
                card.className = 'card mb-3';

                const header = document.createElement('div');
                header.className = 'card-header';

                const patternViz = patternArray.map((present, index) => {
                    const venueName = data.venue_names[index];
                    const badge = present ?
                        `<span class="badge bg-success me-1">${venueName}</span>` :
                        `<span class="badge bg-danger me-1">${venueName}</span>`;
                    return badge;
                }).join('');

                header.innerHTML = `
                    <h6 class="mb-0">
                        Pattern: ${patternViz}
                        <span class="badge bg-primary ms-2">${fields.length} fields</span>
                    </h6>
                `;

                const body = document.createElement('div');
                body.className = 'card-body';

                const fieldList = fields.slice(0, 10).map(field =>
                    `<span class="badge bg-light text-dark pattern-badge">${field}</span>`
                ).join('');

                body.innerHTML = fieldList +
                    (fields.length > 10 ? `<br><small class="text-muted">... and ${fields.length - 10} more fields</small>` : '');

                card.appendChild(header);
                card.appendChild(body);
                container.appendChild(card);
            });
        }

        function generateCharts(data) {
            // Field Distribution Chart
            const ctx1 = document.getElementById('fieldDistributionChart').getContext('2d');
            new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: ['All Venues', 'Multiple Venues', 'Single Venue'],
                    datasets: [{
                        data: [
                            data.summary.fields_in_all_venues,
                            data.summary.fields_in_multiple_venues,
                            data.summary.fields_in_one_venue
                        ],
                        backgroundColor: ['#28a745', '#ffc107', '#dc3545']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Field Distribution'
                        }
                    }
                }
            });

            // Venue Comparison Chart
            const ctx2 = document.getElementById('presenceDistributionChart').getContext('2d');
            const venueCounts = data.venues.map(venue => {
                return Object.values(data.field_matrix).filter(fieldPresence => fieldPresence[venue]).length;
            });

            new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: data.venue_names,
                    datasets: [{
                        label: 'Number of Fields',
                        data: venueCounts,
                        backgroundColor: '#007bff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Fields per Venue'
                        }
                    }
                }
            });
        }

        function filterFieldTable() {
            const nameFilter = document.getElementById('fieldFilter').value.toLowerCase();
            const presenceFilter = document.getElementById('presenceFilter').value;
            const rows = document.querySelectorAll('#fieldPresenceTable tbody tr');

            rows.forEach(row => {
                const fieldName = row.dataset.fieldName;
                const presentCells = row.querySelectorAll('.present').length;
                const totalVenues = analysisData.venues.length;

                let showRow = true;

                // Name filter
                if (nameFilter && !fieldName.includes(nameFilter)) {
                    showRow = false;
                }

                // Presence filter
                if (presenceFilter) {
                    if (presenceFilter === 'all' && presentCells !== totalVenues) showRow = false;
                    if (presenceFilter === 'multiple' && (presentCells <= 1 || presentCells === totalVenues)) showRow = false;
                    if (presenceFilter === 'single' && presentCells !== 1) showRow = false;
                }

                row.style.display = showRow ? '' : 'none';
            });
        }
    </script>
</body>
</html>